<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" />
    <title>HTML Viewer - Super Lite</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

    <style>
      :root {
        --bg: #0b1220;
        --tiktok-bg: #000000;
        --surface: rgba(255, 255, 255, 0.06);
        --text: rgba(255, 255, 255, 0.95);
        --muted: rgba(255, 255, 255, 0.7);
        --border: rgba(255, 255, 255, 0.12);
        --accent: #7c3aed;
        --danger: #ef4444;
        --radius: 14px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        font-family:
          'Inter',
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.55;
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* --- TIKTOK MODE STYLES --- */
      body.tiktok-active {
        background: var(--tiktok-bg);
        overflow: hidden;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 18px;
        position: relative;
        z-index: 2;
      }

      body.tiktok-active .container {
        padding: 0;
        pointer-events: none;
      }
      body.tiktok-active .container > * {
        pointer-events: auto;
      }

      /* --- INDICATOR --- */
      #image-counter {
        position: fixed;
        top: 24px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        padding: 6px 16px;
        border-radius: 99px;
        color: white;
        font-size: 0.9rem;
        font-weight: 600;
        z-index: 150;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      body.tiktok-active #image-counter {
        opacity: 1;
      }

      /* --- FLOATING NAV --- */
      .floating-nav-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 200;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 12px;
      }

      .floating-btn {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: white;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
      }

      #quick-reset-btn {
        background: rgba(239, 68, 68, 0.3);
        border-color: rgba(239, 68, 68, 0.4);
        color: #fca5a5;
      }
      #view-toggle-btn {
        background: rgba(124, 58, 237, 0.3);
        border-color: rgba(124, 58, 237, 0.4);
        color: #a78bfa;
      }

      .nav-menu {
        background: #121218;
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 8px;
        display: none;
        flex-direction: column;
        gap: 6px;
        min-width: 180px;
        position: absolute;
        top: 0;
        right: 55px; /* Simple positioning */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        pointer-events: auto;
      }
      .nav-menu.open {
        display: flex;
      }

      .nav-item {
        background: transparent;
        border: none;
        color: var(--text);
        padding: 12px 16px;
        text-align: left;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.95rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .nav-item:hover {
        background: rgba(255, 255, 255, 0.08);
      }
      .nav-item.hidden {
        display: none;
      }

      /* --- BUILDER --- */
      .card {
        background: #1e1e24;
        border: 1px solid var(--border);
        border-radius: var(--radius);
      }
      .builder {
        padding: 16px;
        display: grid;
        gap: 12px;
        pointer-events: auto;
        background: #111;
        margin-top: 20px;
      }
      .builder textarea {
        width: 100%;
        min-height: 180px;
        resize: vertical;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #222;
        color: var(--text);
        outline: none;
      }
      .builder textarea:focus {
        border-color: var(--accent);
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .btn {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn.primary {
        background: var(--accent);
        border-color: var(--accent);
      }
      .btn.good {
        background: rgba(34, 197, 94, 0.2);
        border-color: #22c55e;
        color: #86efac;
      }
      .btn.danger {
        background: rgba(239, 68, 68, 0.15);
        border-color: var(--danger);
        color: #fca5a5;
      }
      .field {
        width: 100%;
        display: grid;
        gap: 8px;
      }
      .field input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #222;
        color: var(--text);
      }
      .error {
        border: 1px solid var(--danger);
        background: rgba(239, 68, 68, 0.1);
        color: white;
        padding: 10px 12px;
        border-radius: 12px;
        margin-top: 12px;
        pointer-events: auto;
      }

      /* --- TIKTOK MODE (SCROLL) --- */
      #images-section.tiktok-mode {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 1;
        background: black;
        overflow-y: scroll;
        scroll-snap-type: y mandatory;
        padding: 0;
        margin: 0;
        border: none;
        scrollbar-width: none;
        overscroll-behavior: contain;
      }
      #images-section.tiktok-mode::-webkit-scrollbar {
        display: none;
      }

      .tiktok-mode .tiktok-grid {
        width: 100%;
        display: block;
      }

      .tiktok-mode .tiktok-slide {
        width: 100%;
        height: 100vh;
        scroll-snap-align: start;
        scroll-snap-stop: always;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        overflow: hidden;
        background: black;
      }

      /* Main Image - Simplified */
      .tiktok-slide .main-img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
        transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Smooth zoom */
        will-change: transform;
      }

      .tiktok-slide {
        background: #080808;
      }

      /* --- GRID MODE --- */
      #images-section.grid-mode {
        position: relative;
        z-index: 1;
        background: var(--bg);
        padding: 80px 10px 40px;
        min-height: 100vh;
        overflow-y: visible;
      }
      .grid-mode .tiktok-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 2px;
        width: 100%;
      }
      .grid-mode .tiktok-slide {
        width: 100%;
        height: auto;
        aspect-ratio: 1 / 1;
        display: block;
        border-radius: 0;
        overflow: hidden;
        background: #111;
        border: none;
        cursor: pointer;
      }
      .grid-mode .main-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      /* --- OVERLAY PANELS --- */
      .overlay-section {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        max-height: 80vh;
        background: #15151a;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        z-index: 101;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.8);
        overflow-y: auto;
        transform: translateY(110%);
        transition: transform 0.2s ease-out;
        display: block !important;
        border: 1px solid rgba(255, 255, 255, 0.1);
        pointer-events: auto;
      }
      .overlay-section.open {
        transform: translateY(0);
      }
      .overlay-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        padding: 15px 20px;
        background: #1a1a1a;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 10;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
      }
      .overlay-title {
        font-weight: 600;
        font-size: 1rem;
      }
      .btn-close-overlay {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.2rem;
      }

      .img-error-msg {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        color: #fca5a5;
        background: #222;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        font-size: 0.8rem;
        width: 100%;
        height: 100%;
        justify-content: center;
      }

      /* --- MEDIA ITEMS (Updated for Iframe Player) --- */

      /* New style for Playable Iframe Wrapper (Responsive 16:9) */
      .iframe-wrapper {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        height: 0;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 20px;
        border: 1px solid var(--border);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      .iframe-wrapper iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
      }

      /* Old style kept just in case, but unused for iframes now */
      .iframe-replacement-card {
        background: #1e1e24;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 16px;
        text-decoration: none;
        color: var(--text);
        margin-bottom: 12px;
      }
      .iframe-icon {
        color: var(--accent);
      }
      .iframe-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
        overflow: hidden;
      }
      .iframe-title {
        font-weight: 600;
        font-size: 0.95rem;
      }
      .iframe-url {
        font-size: 0.8rem;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 14px;
      }
      .media-item {
        background: black;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border);
      }
      .media-item video {
        width: 100%;
        display: block;
      }

      .links {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
      }
      .link-pill {
        padding: 8px 16px;
        border-radius: 99px;
        background: rgba(124, 58, 237, 0.15);
        border: 1px solid rgba(124, 58, 237, 0.3);
        color: var(--text);
        text-decoration: none;
        font-size: 0.9rem;
      }

      @media (min-width: 768px) {
        .grid-mode .tiktok-grid {
          grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
          gap: 8px;
          padding: 80px 20px 40px;
        }
        .grid-mode .tiktok-slide {
          border-radius: 8px;
        }
      }
    </style>
  </head>

  <body>
    <div id="image-counter">1 / 1</div>

    <div class="floating-nav-container">
      <button id="view-toggle-btn" class="floating-btn" title="Ganti Tampilan" style="display: none">
        <svg id="icon-grid" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        <svg id="icon-scroll" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none">
          <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
          <line x1="12" y1="18" x2="12.01" y2="18"></line>
        </svg>
      </button>

      <button id="quick-reset-btn" class="floating-btn" title="Reset" style="display: none">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
      </button>

      <button id="menu-btn" class="floating-btn" aria-label="Menu" style="display: none">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>

      <div id="nav-menu" class="nav-menu">
        <button id="nav-images" class="nav-item hidden" data-target="images-section">Gambar</button>
        <button id="nav-iframes" class="nav-item hidden" data-target="iframes-section">Link Video</button>
        <button id="nav-videos" class="nav-item hidden" data-target="videos-section">Video</button>
        <button id="nav-links" class="nav-item hidden" data-target="links-section">Link Lain</button>
      </div>
    </div>

    <div class="container">
      <div id="hash-error" class="error" style="display: none"></div>

      <div id="builder" class="card builder" style="display: none">
        <div class="hint" style="color: #999; margin-bottom: 5px">Tempel kode HTML (img, iframe, a) di sini:</div>
        <textarea id="input-html" placeholder="<img src='...'>"></textarea>
        <div class="row">
          <button id="btn-generate" class="btn primary">Generate</button>
          <button id="btn-clear" class="btn danger">Clear</button>
        </div>
        <div class="field" id="generated-field" style="margin-top: 10px">
          <input id="generated-link" readonly placeholder="Result link..." />
          <div class="row">
            <button id="btn-copy" class="btn good">Copy Link</button>
            <button id="btn-copy-encoded" class="btn good">Copy Code</button>
          </div>
          <input id="generated-encoded" readonly placeholder="Encoded code..." style="margin-top: 5px" />
        </div>
      </div>

      <div id="viewer" class="sections" style="display: none">
        <div id="images-section" class="section hidden tiktok-mode">
          <div id="images-grid" class="tiktok-grid"></div>
        </div>

        <div id="iframes-section" class="section hidden overlay-section">
          <div class="overlay-header"><span class="overlay-title">Link Video</span><button class="btn-close-overlay">×</button></div>
          <div id="iframes-grid" style="display: flex; flex-direction: column"></div>
        </div>

        <div id="videos-section" class="section hidden overlay-section">
          <div class="overlay-header"><span class="overlay-title">Video</span><button class="btn-close-overlay">×</button></div>
          <div id="videos-grid" class="media-grid"></div>
        </div>

        <div id="links-section" class="section hidden overlay-section">
          <div class="overlay-header"><span class="overlay-title">Link Lainnya</span><button class="btn-close-overlay">×</button></div>
          <div id="links-container" class="links"></div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Elements
        const els = {
          builder: document.getElementById('builder'),
          viewer: document.getElementById('viewer'),
          error: document.getElementById('hash-error'),
          input: document.getElementById('input-html'),
          genLink: document.getElementById('generated-link'),
          genEnc: document.getElementById('generated-encoded'),
          counter: document.getElementById('image-counter'),
          menuBtn: document.getElementById('menu-btn'),
          menu: document.getElementById('nav-menu'),
          resetBtn: document.getElementById('quick-reset-btn'),
          viewBtn: document.getElementById('view-toggle-btn'),
          iconGrid: document.getElementById('icon-grid'),
          iconScroll: document.getElementById('icon-scroll'),
          imgSec: document.getElementById('images-section'),
          imgGrid: document.getElementById('images-grid'),
        };

        const sections = {
          images: { c: els.imgSec, btn: document.getElementById('nav-images'), count: 0 },
          iframes: { c: document.getElementById('iframes-section'), btn: document.getElementById('nav-iframes'), count: 0, grid: document.getElementById('iframes-grid') },
          videos: { c: document.getElementById('videos-section'), btn: document.getElementById('nav-videos'), count: 0, grid: document.getElementById('videos-grid') },
          links: { c: document.getElementById('links-section'), btn: document.getElementById('nav-links'), count: 0, grid: document.getElementById('links-container') },
        };

        // State
        let isGridView = false;

        // --- Core Utils (Restored) ---
        function packHtml(html) {
          return LZString.compressToEncodedURIComponent(html || '');
        }
        function unpackHtml(packed) {
          return LZString.decompressFromEncodedURIComponent(packed || '');
        }
        function makeUrlWithPacked(packed) {
          const url = new URL(location.href);
          url.hash = 'h=' + packed;
          return url.toString();
        }
        function getGistRawUrlFromParams(params) {
          const gr = params.get('gr');
          if (gr && gr.trim()) {
            const v = gr.trim();
            try {
              return decodeURIComponent(v);
            } catch {
              return v;
            }
          }
          const user = (params.get('u') || '').trim();
          const gistId = (params.get('g') || '').trim();
          const filename = (params.get('f') || '').trim();
          if (!user || !gistId || !filename) return '';
          return `https://gist.githubusercontent.com/${encodeURIComponent(user)}/${encodeURIComponent(gistId)}/raw/${encodeURIComponent(filename)}`;
        }
        async function fetchText(url) {
          const res = await fetch(url, { cache: 'no-store' });
          if (!res.ok) throw new Error('Gagal fetch gist');
          return await res.text();
        }
        async function copyText(value) {
          if (!value) return;
          try {
            await navigator.clipboard.writeText(value);
          } catch {
            const tmp = document.createElement('textarea');
            tmp.value = value;
            document.body.appendChild(tmp);
            tmp.select();
            document.execCommand('copy');
            tmp.remove();
          }
        }

        // --- View Toggling ---
        els.viewBtn.addEventListener('click', () => {
          isGridView = !isGridView;
          updateViewMode();
        });

        function updateViewMode() {
          if (isGridView) {
            els.imgSec.classList.remove('tiktok-mode');
            els.imgSec.classList.add('grid-mode');
            document.body.classList.remove('tiktok-active');
            els.iconGrid.style.display = 'none';
            els.iconScroll.style.display = 'block';
            els.viewBtn.title = 'Scroll View';
            els.counter.style.opacity = '0';
          } else {
            els.imgSec.classList.remove('grid-mode');
            els.imgSec.classList.add('tiktok-mode');
            document.body.classList.add('tiktok-active');
            els.iconGrid.style.display = 'block';
            els.iconScroll.style.display = 'none';
            els.viewBtn.title = 'Grid View';
            els.counter.style.opacity = '1';
          }
        }

        // --- Render Logic ---
        function addImage(imgEl, hrefOverride) {
          const slide = document.createElement('div');
          slide.className = 'tiktok-slide';

          const rawSrc = imgEl.getAttribute('data-url') || imgEl.src;
          const targetHref = normalizeUrl(hrefOverride || rawSrc || '');

          // Create anchor first to ensure error message is clickable
          const a = document.createElement('a');
          a.href = targetHref;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.style.display = 'contents';

          const mainImg = imgEl.cloneNode(true);
          stripSize(mainImg);
          mainImg.className = 'main-img';
          mainImg.setAttribute('loading', 'lazy');

          mainImg.onerror = function () {
            this.style.display = 'none';
            const err = document.createElement('div');
            err.className = 'img-error-msg';
            err.innerHTML =
              '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom:8px"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg><div>Gagal load</div><div style="font-size:0.7em; opacity:0.7">(Klik untuk buka)</div>';
            a.appendChild(err); // Append to 'a' so it remains clickable
          };

          a.appendChild(mainImg);
          slide.appendChild(a);

          // --- Double Click Zoom & Targeted Zoom Logic ---
          let isZoomed = false;
          let clickTimer = null;

          a.addEventListener('click', (e) => {
            // Logic for Grid View
            if (isGridView) {
              e.preventDefault();
              isGridView = false;
              updateViewMode();
              slide.scrollIntoView({ block: 'center' });
              return;
            }

            // Logic for Immersive Mode (Double Click Zoom)
            e.preventDefault(); // Stop immediate navigation

            if (clickTimer) {
              // --- Double Click Detected ---
              clearTimeout(clickTimer);
              clickTimer = null;

              if (isZoomed) {
                // Action: Zoom Out (Reset)
                mainImg.style.transform = 'scale(1)';
                mainImg.style.zIndex = 'auto';
                isZoomed = false;
              } else {
                // Action: Zoom In (Targeted)
                const rect = mainImg.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                mainImg.style.transformOrigin = `${x}px ${y}px`;
                mainImg.style.transform = 'scale(2)';
                mainImg.style.zIndex = '50';
                isZoomed = true;
              }
            } else {
              // --- Single Click Detected (Start Timer) ---
              clickTimer = setTimeout(() => {
                clickTimer = null;
                if (!isZoomed) {
                  // Action: Open Link (if not zoomed)
                  window.open(targetHref, '_blank');
                } else {
                  // Action: Reset Zoom (if zoomed) - Optional UX choice
                  mainImg.style.transform = 'scale(1)';
                  mainImg.style.zIndex = 'auto';
                  isZoomed = false;
                }
              }, 250); // Delay for double tap detection
            }
          });

          els.imgGrid.appendChild(slide);
          sections.images.count++;
        }

        // --- MODIFIED: addIframe Function (AUTO HTTPS FIX) ---
        function addIframe(el) {
          let src = el.src;
          // Domain replacement logic
          if (src.includes('saint2.cr')) src = src.replace('saint2.cr', 'turbovid.cr');

          // --- NEW: FORCE HTTPS ---
          // Jika link iframe menggunakan http://, ganti paksa ke https://
          if (src.startsWith('http://')) {
            src = src.replace('http://', 'https://');
          }

          // Create Responsive Wrapper
          const wrapper = document.createElement('div');
          wrapper.className = 'iframe-wrapper';

          // Create the Actual Iframe with requested attributes
          const iframe = document.createElement('iframe');
          iframe.src = normalizeUrl(src);

          // Set attributes exactly as requested
          iframe.setAttribute('width', '640');
          iframe.setAttribute('height', '360');
          iframe.setAttribute('frameborder', '0');
          iframe.setAttribute('scrolling', 'no');
          iframe.setAttribute('allowfullscreen', 'true');

          wrapper.appendChild(iframe);
          sections.iframes.grid.appendChild(wrapper);
          sections.iframes.count++;
        }

        function addVideo(el) {
          const div = document.createElement('div');
          div.className = 'media-item';
          const vid = el.cloneNode(true);
          stripSize(vid);
          vid.controls = true;
          div.appendChild(vid);
          sections.videos.grid.appendChild(div);
          sections.videos.count++;
        }

        function addLink(el) {
          const a = el.cloneNode(true);
          a.className = 'link-pill';
          a.target = '_blank';
          a.textContent = (a.textContent || a.href).substring(0, 30);
          sections.links.grid.appendChild(a);
          sections.links.count++;
        }

        function processAnchor(a) {
          if (a.querySelector('img')) return addImage(a.querySelector('img'), a.href);
          if (a.querySelector('video')) return addVideo(a.querySelector('video'));
          if (a.querySelector('iframe')) return addIframe(a.querySelector('iframe'));
          addLink(a);
        }

        function renderHtml(html) {
          resetUI();
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');

          walk(doc.body);

          Object.values(sections).forEach((s) => {
            if (s.count > 0) {
              s.btn.classList.remove('hidden');
              s.c.classList.remove('hidden');
            }
          });

          if (sections.images.count > 0) {
            document.body.classList.add('tiktok-active');
            els.viewBtn.style.display = 'flex';
            els.counter.textContent = `1 / ${sections.images.count}`;
          } else {
            els.viewBtn.style.display = 'none';
          }
        }

        function walk(root) {
          for (let child of Array.from(root.children)) {
            const tag = child.tagName.toLowerCase();
            if (tag === 'img') addImage(child);
            else if (tag === 'video') addVideo(child);
            else if (tag === 'iframe') addIframe(child);
            else if (tag === 'a') processAnchor(child);
            else walk(child);
          }
        }

        function resetUI() {
          els.error.style.display = 'none';
          els.imgGrid.innerHTML = '';
          sections.iframes.grid.innerHTML = '';
          sections.videos.grid.innerHTML = '';
          sections.links.grid.innerHTML = '';
          Object.values(sections).forEach((s) => {
            s.count = 0;
            s.btn.classList.add('hidden');
            s.c.classList.add('hidden');
            if (s !== sections.images) s.c.classList.remove('open');
          });
          document.body.classList.remove('tiktok-active');
          isGridView = false;
          updateViewMode();
        }

        function stripSize(el) {
          el.removeAttribute('width');
          el.removeAttribute('height');
          el.removeAttribute('style');
        }
        function normalizeUrl(u) {
          try {
            return new URL(u, location.href).toString();
          } catch {
            return u;
          }
        }

        els.imgSec.addEventListener('scroll', () => {
          if (isGridView || !sections.images.count) return;
          const idx = Math.round(els.imgSec.scrollTop / window.innerHeight) + 1;
          els.counter.textContent = `${Math.min(Math.max(idx, 1), sections.images.count)} / ${sections.images.count}`;
        });

        els.menuBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          els.menu.classList.toggle('open');
        });
        document.addEventListener('click', (e) => {
          if (!els.menu.contains(e.target) && !els.menuBtn.contains(e.target)) els.menu.classList.remove('open');
        });

        els.menu.addEventListener('click', (e) => {
          const btn = e.target.closest('button');
          if (!btn) return;
          const target = btn.getAttribute('data-target');
          if (!target) return;
          els.menu.classList.remove('open');
          if (target === 'images-section') {
            document.querySelectorAll('.overlay-section').forEach((el) => el.classList.remove('open'));
          } else {
            document.querySelectorAll('.overlay-section').forEach((el) => el.classList.remove('open'));
            document.getElementById(target).classList.add('open');
          }
        });

        document.addEventListener('click', (e) => {
          if (e.target.closest('.btn-close-overlay')) e.target.closest('.overlay-section').classList.remove('open');
        });
        els.resetBtn.addEventListener('click', () => {
          history.replaceState(null, '', location.pathname);
          runByHash();
        });

        let lastRunToken = 0;
        async function runByHash() {
          const token = ++lastRunToken;
          const params = new URLSearchParams(location.hash.slice(1));
          const packed = params.get('h');
          const gistRawUrl = getGistRawUrlFromParams(params);

          if (!packed && !gistRawUrl) {
            els.builder.style.display = 'grid';
            els.viewer.style.display = 'none';
            els.menuBtn.style.display = 'none';
            els.resetBtn.style.display = 'none';
            els.viewBtn.style.display = 'none';
            return;
          }

          els.builder.style.display = 'none';
          els.viewer.style.display = 'block';
          els.menuBtn.style.display = 'flex';
          els.resetBtn.style.display = 'flex';

          try {
            let htmlContent = packed;
            if (!htmlContent && gistRawUrl) {
              els.error.textContent = 'Loading gist...';
              els.error.style.display = 'block';
              const text = await fetchText(gistRawUrl);
              if (token !== lastRunToken) return;
              htmlContent = (text || '').trim();
            }

            const html = unpackHtml(htmlContent);
            if (!html) throw new Error('Data corrupt');

            els.error.style.display = 'none';
            renderHtml(html);
          } catch (e) {
            els.error.textContent = e.message || 'Error loading content';
            els.error.style.display = 'block';
            els.builder.style.display = 'grid';
          }
        }

        document.getElementById('btn-generate').addEventListener('click', () => {
          const v = els.input.value.trim();
          if (!v) return;
          const p = packHtml(v);
          els.genEnc.value = p;
          els.genLink.value = makeUrlWithPacked(p);
          location.hash = 'h=' + p;
        });

        document.getElementById('btn-clear').addEventListener('click', () => {
          els.input.value = '';
          els.genLink.value = '';
          els.genEnc.value = '';
        });

        document.getElementById('btn-copy').addEventListener('click', () => copyText(els.genLink.value));
        document.getElementById('btn-copy-encoded').addEventListener('click', () => copyText(els.genEnc.value));

        document.addEventListener('keydown', (e) => {
          if (isGridView || els.imgSec.classList.contains('hidden')) return;
          if (e.key === 'ArrowDown') els.imgSec.scrollBy({ top: window.innerHeight, behavior: 'smooth' });
          if (e.key === 'ArrowUp') els.imgSec.scrollBy({ top: -window.innerHeight, behavior: 'smooth' });
        });

        window.addEventListener('hashchange', runByHash);
        runByHash();
      });
    </script>
  </body>
</html>
